@model RentalTourismSystem.Models.Cliente
@{
    ViewData["Title"] = "Novo Cliente";
}

<div class="row">
    <div class="col-12">
        <h2 class="text-gradient">
            <i class="fas fa-user-plus me-2"></i>Cadastrar Novo Cliente
        </h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-action="Index" class="text-decoration-none">Clientes</a></li>
                <li class="breadcrumb-item active">Novo Cliente</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card hover-lift">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-user me-2"></i>Dados do Cliente
                </h5>
            </div>
            <div class="card-body">
                <form asp-action="Create" method="post">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <!-- Seção: Informações Pessoais -->
                    <h6 class="text-primary border-bottom pb-2 mb-3">
                        <i class="fas fa-id-card me-2"></i>Informações Pessoais
                    </h6>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label asp-for="Nome" class="form-label required"></label>
                            <input asp-for="Nome" class="form-control" placeholder="Nome completo do cliente" />
                            <span asp-validation-for="Nome" class="text-danger small"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="DataNascimento" class="form-label required"></label>
                            <input asp-for="DataNascimento" class="form-control" type="date" />
                            <span asp-validation-for="DataNascimento" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="CPF" class="form-label required"></label>
                            <input asp-for="CPF" class="form-control" id="cpfInput" placeholder="000.000.000-00" maxlength="14" />
                            <span asp-validation-for="CPF" class="text-danger small"></span>
                            <small class="form-text text-muted">Apenas números são aceitos</small>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="EstadoCivil" class="form-label"></label>
                            <select asp-for="EstadoCivil" class="form-select">
                                <option value="">Selecione...</option>
                                <option value="Solteiro(a)">Solteiro(a)</option>
                                <option value="Casado(a)">Casado(a)</option>
                                <option value="Divorciado(a)">Divorciado(a)</option>
                                <option value="Viúvo(a)">Viúvo(a)</option>
                                <option value="União Estável">União Estável</option>
                            </select>
                            <span asp-validation-for="EstadoCivil" class="text-danger small"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="Profissao" class="form-label"></label>
                            <input asp-for="Profissao" class="form-control" placeholder="Profissão do cliente" />
                            <span asp-validation-for="Profissao" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Seção: Contato -->
                    <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                        <i class="fas fa-phone me-2"></i>Contato
                    </h6>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="Telefone" class="form-label required"></label>
                            <input asp-for="Telefone" class="form-control" id="telefoneInput" placeholder="(00) 00000-0000" maxlength="15" />
                            <span asp-validation-for="Telefone" class="text-danger small"></span>
                            <small class="form-text text-muted">10 ou 11 dígitos</small>
                        </div>

                        <div class="col-md-8 mb-3">
                            <label asp-for="Email" class="form-label required"></label>
                            <input asp-for="Email" class="form-control" type="email" placeholder="email@exemplo.com" />
                            <span asp-validation-for="Email" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Seção: Endereço -->
                    <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                        <i class="fas fa-map-marker-alt me-2"></i>Endereço
                    </h6>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label asp-for="CEP" class="form-label"></label>
                            <input asp-for="CEP" class="form-control" id="cepInput" placeholder="00000-000" maxlength="9" />
                            <span asp-validation-for="CEP" class="text-danger small"></span>
                        </div>

                        <div class="col-md-9 mb-3">
                            <label asp-for="Endereco" class="form-label required"></label>
                            <input asp-for="Endereco" class="form-control" id="enderecoInput" placeholder="Rua, número, complemento, bairro, cidade - UF" />
                            <span asp-validation-for="Endereco" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Seção: CNH -->
                    <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                        <i class="fas fa-id-card-alt me-2"></i>Carteira Nacional de Habilitação
                    </h6>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>CNH é opcional.</strong> Necessária apenas para locação de veículos.
                    </div>

                    <div class="row">
                        <div class="col-md-5 mb-3">
                            <label asp-for="CNH" class="form-label"></label>
                            <input asp-for="CNH" class="form-control" placeholder="Número da CNH" />
                            <span asp-validation-for="CNH" class="text-danger small"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="ValidadeCNH" class="form-label"></label>
                            <input asp-for="ValidadeCNH" class="form-control" type="date" />
                            <span asp-validation-for="ValidadeCNH" class="text-danger small"></span>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label asp-for="CategoriaCNH" class="form-label"></label>
                            <select asp-for="CategoriaCNH" class="form-select">
                                <option value="">Selecione...</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="AB">AB</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                            </select>
                            <span asp-validation-for="CategoriaCNH" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Salvar
                        </button>
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Voltar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar com Informações -->
    <div class="col-lg-4">
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-1"></i>Campos Obrigatórios
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0 small">
                    <li class="mb-1">
                        <i class="fas fa-check text-success me-1"></i>Nome completo
                    </li>
                    <li class="mb-1">
                        <i class="fas fa-check text-success me-1"></i>CPF válido e único
                    </li>
                    <li class="mb-1">
                        <i class="fas fa-check text-success me-1"></i>Email válido e único
                    </li>
                    <li class="mb-1">
                        <i class="fas fa-check text-success me-1"></i>Telefone (10 ou 11 dígitos)
                    </li>
                    <li class="mb-1">
                        <i class="fas fa-check text-success me-1"></i>Data de nascimento (21+ anos)
                    </li>
                    <li class="mb-1">
                        <i class="fas fa-check text-success me-1"></i>Endereço completo
                    </li>
                </ul>
            </div>
        </div>

        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-question-circle me-1"></i>Ajuda
                </h6>
            </div>
            <div class="card-body">
                <p class="small"><strong>Validações:</strong></p>
                <ul class="small">
                    <li>Idade mínima: 21 anos</li>
                    <li>CPF deve ser válido</li>
                    <li>Email deve ser único</li>
                    <li>Telefone: 10 ou 11 dígitos</li>
                    <li>CNH opcional, mas se informar deve estar válida</li>
                </ul>
                <hr>
                <p class="small"><strong>Dica:</strong></p>
                <p class="small mb-0">Os campos são formatados automaticamente durante a digitação.</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function() {
            // ✅ MÁSCARAS CORRIGIDAS - Aplicar formatação visual sem interferir no valor enviado

            // Máscara de CPF
            $('#cpfInput').on('input', function() {
                let value = this.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    this.value = value;
                }
            });

            // Máscara de Telefone
            $('#telefoneInput').on('input', function() {
                let value = this.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    if (value.length <= 10) {
                        value = value.replace(/(\d{2})(\d)/, '($1) $2');
                        value = value.replace(/(\d{4})(\d)/, '$1-$2');
                    } else {
                        value = value.replace(/(\d{2})(\d)/, '($1) $2');
                        value = value.replace(/(\d{5})(\d)/, '$1-$2');
                    }
                    this.value = value;
                }
            });

            // Máscara de CEP
            $('#cepInput').on('input', function() {
                let value = this.value.replace(/\D/g, '');
                if (value.length <= 8) {
                    value = value.replace(/(\d{5})(\d)/, '$1-$2');
                    this.value = value;
                }
            });

            // Buscar endereço por CEP (ViaCEP)
            $('#cepInput').on('blur', function() {
                let cep = this.value.replace(/\D/g, '');
                if (cep.length === 8) {
                    $.getJSON('https://viacep.com.br/ws/' + cep + '/json/', function(data) {
                        if (!data.erro) {
                            let endereco = data.logradouro + ', ' + data.bairro + ', ' +
                                         data.localidade + ' - ' + data.uf;
                            $('#enderecoInput').val(endereco);
                        }
                    }).fail(function() {
                        console.log('Erro ao buscar CEP');
                    });
                }
            });

            // Validação de idade ao mudar data de nascimento
            $('input[name="DataNascimento"]').on('change', function() {
                let dataNasc = new Date(this.value);
                let hoje = new Date();
                let idade = hoje.getFullYear() - dataNasc.getFullYear();
                let m = hoje.getMonth() - dataNasc.getMonth();
                if (m < 0 || (m === 0 && hoje.getDate() < dataNasc.getDate())) {
                    idade--;
                }

                if (idade < 21) {
                    alert('⚠️ Cliente deve ter pelo menos 21 anos. Idade atual: ' + idade + ' anos.');
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid');
                }
            });

            // Validação de CNH - CORRIGIDA para não bloquear digitação
            let cnhValidationTimeout;
            
            $('input[name="CNH"], input[name="ValidadeCNH"], select[name="CategoriaCNH"]').on('input change', function() {
                // Limpar timeout anterior para evitar validações múltiplas
                clearTimeout(cnhValidationTimeout);
                
                // Aguardar 500ms após parar de digitar para validar
                cnhValidationTimeout = setTimeout(function() {
                    validarCNH();
                }, 500);
            });

            function validarCNH() {
                let cnh = $('input[name="CNH"]').val().trim();
                let validade = $('input[name="ValidadeCNH"]').val();
                let categoria = $('select[name="CategoriaCNH"]').val();
                
                let $cnhInput = $('input[name="CNH"]');
                let $validadeInput = $('input[name="ValidadeCNH"]');
                let $categoriaSelect = $('select[name="CategoriaCNH"]');
                
                // Remover classes de erro anteriores
                $cnhInput.removeClass('is-invalid');
                $validadeInput.removeClass('is-invalid');
                $categoriaSelect.removeClass('is-invalid');
                
                // Remover mensagens de erro anteriores
                $('.cnh-error-message').remove();
                
                // Se nenhum campo da CNH estiver preenchido, não validar
                if (!cnh && !validade && !categoria) {
                    return;
                }
                
                // Validar campos relacionados
                if (cnh && !validade) {
                    $validadeInput.addClass('is-invalid');
                    $validadeInput.after('<small class="text-danger small cnh-error-message d-block">Informe a validade da CNH</small>');
                }
                
                if (cnh && !categoria) {
                    $categoriaSelect.addClass('is-invalid');
                    $categoriaSelect.after('<small class="text-danger small cnh-error-message d-block">Informe a categoria da CNH</small>');
                }
                
                if (validade && !cnh) {
                    $cnhInput.addClass('is-invalid');
                    $cnhInput.after('<small class="text-danger small cnh-error-message d-block">Informe o número da CNH</small>');
                }
                
                if (categoria && !cnh) {
                    $cnhInput.addClass('is-invalid');
                    if (!$cnhInput.next('.cnh-error-message').length) {
                        $cnhInput.after('<small class="text-danger small cnh-error-message d-block">Informe o número da CNH</small>');
                    }
                }
                
                // Validar data de validade
                if (cnh && validade && validade.length === 10) {
                    let dataValidade = new Date(validade);
                    let hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);
                    
                    if (dataValidade < hoje) {
                        $validadeInput.addClass('is-invalid');
                        $('.cnh-error-message').remove();
                        $validadeInput.after('<small class="text-danger small cnh-error-message d-block">A CNH está vencida</small>');
                    }
                }
            }

            // Feedback visual de validação
            $('form').on('submit', function(e) {
                let isValid = true;

                // Validar campos obrigatórios
                $('input[required], select[required]').each(function() {
                    if (!$(this).val()) {
                        $(this).addClass('is-invalid');
                        isValid = false;
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                });
                
                // Validar CNH antes de submeter
                validarCNH();
                
                // Verificar se há campos inválidos (incluindo CNH)
                if ($('.is-invalid').length > 0) {
                    isValid = false;
                }

                if (!isValid) {
                    e.preventDefault();
                    alert('⚠️ Por favor, corrija os erros no formulário.');
                    $('html, body').animate({
                        scrollTop: $('.is-invalid').first().offset().top - 100
                    }, 500);
                }
            });
        });
    </script>
}

<style>
    .required::after {
        content: " *";
        color: red;
    }

    .is-invalid {
        border-color: #dc3545 !important;
    }

    .text-danger.small {
        display: block;
        margin-top: 0.25rem;
    }
</style>
@model RentalTourismSystem.Models.Cliente
@{
    ViewData["Title"] = "Editar Cliente";
}

<div class="row mb-4" style="margin-top: 1rem;">
    <div class="col-12">
        <h2 class="text-gradient mb-2">
            <i class="fas fa-user-edit me-2"></i>Editar Cliente
        </h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-action="Index" class="text-decoration-none">Clientes</a></li>
                <li class="breadcrumb-item"><a asp-action="Details" asp-route-id="@Model.Id" class="text-decoration-none">@Model.Nome</a></li>
                <li class="breadcrumb-item active">Editar</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card hover-lift">
            <div class="card-header bg-warning">
                <h5 class="mb-0">
                    <i class="fas fa-user me-2"></i>Dados do Cliente
                </h5>
            </div>
            <div class="card-body">
                <form asp-action="Edit" method="post">
                    <input type="hidden" asp-for="Id" />
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <!-- Seção: Informações Pessoais -->
                    <h6 class="text-primary border-bottom pb-2 mb-3">
                        <i class="fas fa-id-card me-2"></i>Informações Pessoais
                    </h6>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label asp-for="Nome" class="form-label required"></label>
                            <input asp-for="Nome" class="form-control" />
                            <span asp-validation-for="Nome" class="text-danger small"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="DataNascimento" class="form-label required"></label>
                            <input asp-for="DataNascimento" class="form-control" type="date" />
                            <span asp-validation-for="DataNascimento" class="text-danger small"></span>
                            <small class="form-text text-muted">Idade atual: @Model.Idade anos</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="CPF" class="form-label required"></label>
                            <input asp-for="CPF" class="form-control" id="cpfInput" maxlength="14" />
                            <span asp-validation-for="CPF" class="text-danger small"></span>
                            <small class="form-text text-muted">Apenas números</small>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="EstadoCivil" class="form-label"></label>
                            <select asp-for="EstadoCivil" class="form-select">
                                <option value="">Selecione...</option>
                                <option value="Solteiro(a)">Solteiro(a)</option>
                                <option value="Casado(a)">Casado(a)</option>
                                <option value="Divorciado(a)">Divorciado(a)</option>
                                <option value="Viúvo(a)">Viúvo(a)</option>
                                <option value="União Estável">União Estável</option>
                            </select>
                            <span asp-validation-for="EstadoCivil" class="text-danger small"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="Profissao" class="form-label"></label>
                            <input asp-for="Profissao" class="form-control" />
                            <span asp-validation-for="Profissao" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Seção: Contato -->
                    <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                        <i class="fas fa-phone me-2"></i>Contato
                    </h6>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="Telefone" class="form-label required"></label>
                            <input asp-for="Telefone" class="form-control" id="telefoneInput" maxlength="15" />
                            <span asp-validation-for="Telefone" class="text-danger small"></span>
                            <small class="form-text text-muted">10 ou 11 dígitos</small>
                        </div>

                        <div class="col-md-8 mb-3">
                            <label asp-for="Email" class="form-label required"></label>
                            <input asp-for="Email" class="form-control" type="email" />
                            <span asp-validation-for="Email" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Seção: Endereço -->
                    <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                        <i class="fas fa-map-marker-alt me-2"></i>Endereço
                    </h6>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label asp-for="CEP" class="form-label"></label>
                            <input asp-for="CEP" class="form-control" id="cepInput" maxlength="9" />
                            <span asp-validation-for="CEP" class="text-danger small"></span>
                        </div>

                        <div class="col-md-9 mb-3">
                            <label asp-for="Endereco" class="form-label required"></label>
                            <input asp-for="Endereco" class="form-control" id="enderecoInput" />
                            <span asp-validation-for="Endereco" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Seção: CNH -->
                    <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                        <i class="fas fa-id-card-alt me-2"></i>Carteira Nacional de Habilitação
                    </h6>

                    @* Mostrar documento CNH enviado no pré-cadastro se existir *@
                    @if (!string.IsNullOrEmpty(Model.CNHPath))
                    {
                        <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-file-image fa-2x text-primary me-3"></i>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-2">
                                        <i class="fas fa-check-circle me-1"></i>Documento CNH Enviado
                                    </h6>
                                    <p class="mb-2">
                                        O cliente anexou um documento durante o pré-cadastro. 
                                        <strong>Verifique o documento e preencha os dados da CNH abaixo.</strong>
                                    </p>
                                    <div class="d-flex gap-2 mt-2">
                                        <button type="button" class="btn btn-sm btn-primary" onclick="visualizarCNHEdit()">
                                            <i class="fas fa-eye me-1"></i>Visualizar Documento
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="downloadCNHEdit()">
                                            <i class="fas fa-download me-1"></i>Baixar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    @if (Model.CNHValida)
                    {
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>CNH válida</strong> até @Model.ValidadeCNH?.ToString("dd/MM/yyyy")
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(Model.CNH))
                    {
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>CNH vencida!</strong> Cliente não pode alugar veículos.
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>CNH não informada.</strong> Necessária apenas para locação de veículos.
                        </div>
                    }

                    <div class="row">
                        <div class="col-md-5 mb-3">
                            <label asp-for="CNH" class="form-label"></label>
                            <input asp-for="CNH" class="form-control" />
                            <span asp-validation-for="CNH" class="text-danger small"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="ValidadeCNH" class="form-label"></label>
                            <input asp-for="ValidadeCNH" class="form-control" type="date" />
                            <span asp-validation-for="ValidadeCNH" class="text-danger small"></span>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label asp-for="CategoriaCNH" class="form-label"></label>
                            <select asp-for="CategoriaCNH" class="form-select">
                                <option value="">Selecione...</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="AB">AB</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                            </select>
                            <span asp-validation-for="CategoriaCNH" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save me-2"></i>Salvar Alterações
                        </button>
                        <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Voltar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar me-1"></i>Estatísticas
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <h4 class="text-primary mb-0">@Model.TotalLocacoes</h4>
                        <small class="text-muted">Locações</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success mb-0">@Model.TotalReservas</h4>
                        <small class="text-muted">Reservas</small>
                    </div>
                </div>

                @if (Model.ValorTotalGasto > 0)
                {
                    <div class="text-center">
                        <small class="text-muted">Valor Total:</small><br>
                        <strong class="text-success h5">@Model.ValorTotalGasto.ToString("C")</strong>
                    </div>
                }

                <hr>
                <div class="small">
                    <p class="mb-1">
                        <i class="fas fa-calendar text-info me-1"></i>
                        <strong>Cliente desde:</strong> @Model.DataCadastro.ToString("dd/MM/yyyy")
                    </p>
                    <p class="mb-0">
                        <i class="fas fa-clock text-warning me-1"></i>
                        <strong>Dias no sistema:</strong> @((DateTime.Now - Model.DataCadastro).Days)
                    </p>
                </div>
            </div>
        </div>

        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-1"></i>Atenção
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning small mb-0">
                    <strong>Importante:</strong> Alterações nos dados podem afetar contratos ativos e histórico do cliente.
                </div>
            </div>
        </div>

        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-1"></i>Campos Obrigatórios
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0 small">
                    <li class="mb-1">
                        <i class="fas fa-check text-success me-1"></i>Nome completo
                    </li>
                    <li class="mb-1">
                        <i class="fas fa-check text-success me-1"></i>CPF (sem alteração)
                    </li>
                    <li class="mb-1">
                        <i class="fas fa-check text-success me-1"></i>Email válido e único
                    </li>
                    <li class="mb-1">
                        <i class="fas fa-check text-success me-1"></i>Telefone válido
                    </li>
                    <li class="mb-1">
                        <i class="fas fa-check text-success me-1"></i>Data de nascimento
                    </li>
                    <li class="mb-1">
                        <i class="fas fa-check text-success me-1"></i>Endereço completo
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function() {
            // ✅ Aplicar máscaras nos campos (mesma lógica do Create)

            // Máscara de CPF
            $('#cpfInput').on('input', function() {
                let value = this.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    this.value = value;
                }
            });

            // Máscara de Telefone
            $('#telefoneInput').on('input', function() {
                let value = this.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    if (value.length <= 10) {
                        value = value.replace(/(\d{2})(\d)/, '($1) $2');
                        value = value.replace(/(\d{4})(\d)/, '$1-$2');
                    } else {
                        value = value.replace(/(\d{2})(\d)/, '($1) $2');
                        value = value.replace(/(\d{5})(\d)/, '$1-$2');
                    }
                    this.value = value;
                }
            });

            // Máscara de CEP
            $('#cepInput').on('input', function() {
                let value = this.value.replace(/\D/g, '');
                if (value.length <= 8) {
                    value = value.replace(/(\d{5})(\d)/, '$1-$2');
                    this.value = value;
                }
            });

            // Buscar endereço por CEP
            $('#cepInput').on('blur', function() {
                let cep = this.value.replace(/\D/g, '');
                if (cep.length === 8) {
                    $.getJSON('https://viacep.com.br/ws/' + cep + '/json/', function(data) {
                        if (!data.erro) {
                            if (confirm('Endereço encontrado:\n' + data.logradouro + ', ' + data.bairro + '\n' + data.localidade + ' - ' + data.uf + '\n\nDeseja preencher o campo de endereço?')) {
                                let endereco = data.logradouro + ', ' + data.bairro + ', ' +
                                             data.localidade + ' - ' + data.uf;
                                $('#enderecoInput').val(endereco);
                            }
                        }
                    }).fail(function() {
                        console.log('Erro ao buscar CEP');
                    });
                }
            });

            // Validação de CNH
            $('input[name="CNH"], input[name="ValidadeCNH"]').on('change', function() {
                let cnh = $('input[name="CNH"]').val();
                let validade = $('input[name="ValidadeCNH"]').val();

                if (cnh && !validade) {
                    alert('⚠️ Se informar o número da CNH, deve informar também a validade.');
                }

                if (validade && !cnh) {
                    alert('⚠️ Se informar a validade da CNH, deve informar também o número.');
                }

                if (cnh && validade) {
                    let dataValidade = new Date(validade);
                    let hoje = new Date();

                    if (dataValidade < hoje) {
                        alert('⚠️ A CNH está vencida.');
                    }
                }
            });

            // Validação antes de enviar
            $('form').on('submit', function(e) {
                let isValid = true;

                $('input[required]').each(function() {
                    if (!$(this).val()) {
                        $(this).addClass('is-invalid');
                        isValid = false;
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    alert('⚠️ Por favor, preencha todos os campos obrigatórios.');
                    $('html, body').animate({
                        scrollTop: $('.is-invalid').first().offset().top - 100
                    }, 500);
                }
            });

            // Aplicar máscaras nos valores existentes ao carregar
            setTimeout(function() {
                $('#cpfInput').trigger('input');
                $('#telefoneInput').trigger('input');
                $('#cepInput').trigger('input');
            }, 100);

            // Se veio de validação de pré-cadastro, destacar o alerta
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('fromValidation') === 'true') {
                // Aguardar a página carregar completamente
                setTimeout(() => {
                    const cnhSection = document.querySelector('h6:has(.fa-id-card-alt)');
                    if (cnhSection) {
                        // Calcular posição com offset para não cortar o topo
                        const offset = 100; // Espaço do header/navbar
                        const elementPosition = cnhSection.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - offset;

                        // Scroll suave até a seção, mas sem esconder o topo
                        window.scrollTo({
                            top: Math.max(0, offsetPosition), // Não permitir scroll negativo
                            behavior: 'smooth'
                        });
                        
                        // Destacar o alerta por alguns segundos
                        const alert = document.querySelector('.alert-info.alert-dismissible');
                        if (alert) {
                            alert.style.animation = 'pulse 0.5s ease-in-out 3';
                        }
                    }

                    // Mostrar notificação
                    if (window.NotificationSystem) {
                        window.NotificationSystem.info('Verifique o documento CNH e preencha os dados abaixo', 5000);
                    }
                }, 800); // Aumentado para 800ms para garantir que a página carregou
            }
        });

        // Funções para visualizar e baixar CNH
        var clienteId = @Model.Id;
        var clienteNome = '@Html.Raw(Html.Encode(Model.Nome))';
        var cnhPath = '@Html.Raw(Model.CNHPath ?? "")';

        function visualizarCNHEdit() {
            if (!cnhPath) {
                if (window.NotificationSystem) {
                    window.NotificationSystem.warning('Nenhum documento CNH encontrado.');
                }
                return;
            }

            const fileExtension = cnhPath.split('.').pop().toLowerCase();
            const fileUrl = `/Clientes/GetCNHFile?id=${clienteId}`;

            if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(fileExtension)) {
                // Mostrar imagem em modal
                const modalHtml = `
                    <div class="modal fade" id="cnhModalEdit" tabindex="-1">
                        <div class="modal-dialog modal-xl modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-id-card me-2"></i>CNH Enviada - ${clienteNome}
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body text-center p-3" style="background-color: #f8f9fa;">
                                    <div class="spinner-border text-primary mb-3" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                    <p class="text-muted">Carregando imagem...</p>
                                    <img src="${fileUrl}" class="img-fluid rounded shadow d-none" alt="CNH" 
                                         style="max-height: 75vh; max-width: 100%; object-fit: contain;"
                                         onload="this.classList.remove('d-none'); this.previousElementSibling.previousElementSibling.classList.add('d-none'); this.previousElementSibling.classList.add('d-none');"
                                         onerror="this.onerror=null; this.alt='Erro ao carregar imagem'; this.previousElementSibling.innerHTML='<i class=\\'fas fa-exclamation-triangle text-danger fa-3x\\'></i><p class=\\'text-danger mt-3\\'>Erro ao carregar a imagem</p>'; this.previousElementSibling.previousElementSibling.classList.add('d-none');">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-outline-secondary" onclick="downloadCNHEdit()">
                                        <i class="fas fa-download me-1"></i>Baixar
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal anterior se existir
                $('#cnhModalEdit').remove();
                
                // Adicionar e mostrar novo modal
                $('body').append(modalHtml);
                const modal = new bootstrap.Modal(document.getElementById('cnhModalEdit'));
                modal.show();
                
            } else if (fileExtension === 'pdf') {
                // Para PDF, abrir em nova aba
                window.open(fileUrl, '_blank');
            } else {
                // Para outros tipos, forçar download
                downloadCNHEdit();
            }
        }

        function downloadCNHEdit() {
            if (!cnhPath) {
                if (window.NotificationSystem) {
                    window.NotificationSystem.warning('Nenhum documento CNH encontrado.');
                }
                return;
            }

            const fileUrl = `/Clientes/GetCNHFile?id=${clienteId}`;
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = `CNH_${clienteNome.replace(/\s+/g, '_')}.jpg`;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            if (window.NotificationSystem) {
                window.NotificationSystem.success('Download iniciado!');
            }
        }
    </script>
}

<style>
/* Ajustar padding para evitar corte do título */
.content-wrapper {
    padding-top: 2rem !important;
}

/* Garantir espaço adicional no topo quando houver alerts */
.row:first-child {
    margin-top: 1rem;
}

/* Se houver alert visível, aumentar margem */
.alert:not(.alert-dismissible) ~ .row:first-of-type,
.alert-dismissible ~ .row:first-of-type {
    margin-top: 1.5rem !important;
}

/* Marcador de campo obrigatório */
.required::after {
    content: " *";
    color: red;
}

    /* Campo inválido */
    .is-invalid {
        border-color: #dc3545 !important;
    }

    /* Mensagem de erro */
    .text-danger.small {
        display: block;
        margin-top: 0.25rem;
    }

    /* Animação de destaque para validação */
    @@keyframes pulse {
        0%, 100% { 
            transform: scale(1); 
        }
        50% { 
            transform: scale(1.02); 
            box-shadow: 0 0 20px rgba(13, 110, 253, 0.5); 
        }
    }

    /* Garantir scroll suave */
    html {
        scroll-behavior: smooth;
        scroll-padding-top: 80px;
    }

    /* Ajustar modal para CNH */
    .modal-xl {
        max-width: 90%;
    }

    /* Responsividade */
    @@media (max-width: 768px) {
        .modal-xl {
            max-width: 95%;
            margin: 0.5rem auto;
        }

        h2.text-gradient {
            font-size: 1.5rem;
        }
    }
</style>
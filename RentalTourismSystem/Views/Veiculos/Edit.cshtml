@model RentalTourismSystem.Models.Veiculo
@{
    ViewData["Title"] = "Editar Veículo";
    var temLocacoes = Model.Locacoes?.Any() == true;
    var locacoesAtivas = Model.Locacoes?.Where(l => l.DataDevolucaoReal == null).Count() ?? 0;
    var statusAtual = Model.StatusCarro?.Status ?? "Indefinido";
    var podeAlterarStatus = statusAtual != "Alugado" || User.IsInRole("Admin");
}

<div class="row">
    <div class="col-12">
        <h2 class="text-gradient">
            <i class="fas fa-edit me-2"></i>Editar Veículo
        </h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-action="Index" class="text-decoration-none">Veículos</a></li>
                <li class="breadcrumb-item"><a asp-action="Details" asp-route-id="@Model.Id" class="text-decoration-none">@Model.Marca @Model.Modelo</a></li>
                <li class="breadcrumb-item active">Editar</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card hover-lift">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-car me-2"></i>Dados do Veículo</h5>
            </div>
            <div class="card-body">
                <!-- ✅ CORRIGIDO: asp-action="Edit" e ID adicionado -->
                <form asp-action="Edit" method="post" id="formEditarVeiculo">
                    <input type="hidden" asp-for="Id" />
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <!-- Identificação -->
                    <h6 class="text-primary border-bottom pb-2 mb-3">
                        <i class="fas fa-info-circle me-2"></i>Identificação
                    </h6>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="Marca" class="form-label required"></label>
                            <input asp-for="Marca" class="form-control" list="marcas" />
                            <datalist id="marcas">
                                <option value="Toyota" />
                                <option value="Volkswagen" />
                                <option value="Chevrolet" />
                                <option value="Ford" />
                                <option value="Fiat" />
                                <option value="Honda" />
                                <option value="Hyundai" />
                            </datalist>
                            <span asp-validation-for="Marca" class="text-danger small"></span>
                        </div>

                        <div class="col-md-5 mb-3">
                            <label asp-for="Modelo" class="form-label required"></label>
                            <input asp-for="Modelo" class="form-control" />
                            <span asp-validation-for="Modelo" class="text-danger small"></span>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label asp-for="Ano" class="form-label required"></label>
                            <input asp-for="Ano" class="form-control" type="number" min="1990" max="2030" />
                            <span asp-validation-for="Ano" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="Placa" class="form-label required"></label>
                            <input asp-for="Placa" class="form-control" id="placaInput" maxlength="8" />
                            <span asp-validation-for="Placa" class="text-danger small"></span>
                            <small class="text-muted">Formato antigo ou Mercosul</small>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="Cor" class="form-label required"></label>
                            <input asp-for="Cor" class="form-control" />
                            <span asp-validation-for="Cor" class="text-danger small"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="Quilometragem" class="form-label required"></label>
                            <input asp-for="Quilometragem" class="form-control" type="number" min="0" />
                            <span asp-validation-for="Quilometragem" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Características -->
                    <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                        <i class="fas fa-cogs me-2"></i>Características
                    </h6>

                    <div class="row">
                        <!-- ✅ CORRIGIDO: Campos Combustivel e Cambio -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="Combustivel" class="form-label required"></label>
                            <select asp-for="Combustivel" class="form-select">
                                <option value="">Selecione...</option>
                                <option value="Gasolina">Gasolina</option>
                                <option value="Álcool">Álcool</option>
                                <option value="Flex">Flex (Gasolina/Álcool)</option>
                                <option value="Diesel">Diesel</option>
                                <option value="GNV">GNV</option>
                                <option value="Híbrido">Híbrido</option>
                                <option value="Elétrico">Elétrico</option>
                            </select>
                            <span asp-validation-for="Combustivel" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label asp-for="Cambio" class="form-label required"></label>
                            <select asp-for="Cambio" class="form-select">
                                <option value="">Selecione...</option>
                                <option value="Manual">Manual</option>
                                <option value="Automático">Automático</option>
                                <option value="Automatizado">Automatizado</option>
                                <option value="CVT">CVT</option>
                            </select>
                            <span asp-validation-for="Cambio" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Valores e Status -->
                    <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                        <i class="fas fa-dollar-sign me-2"></i>Valor e Status
                    </h6>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="ValorDiaria" class="form-label required"></label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input asp-for="ValorDiaria" class="form-control" />
                            </div>
                            <span asp-validation-for="ValorDiaria" class="text-danger small"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="ValorMercado" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input asp-for="ValorMercado" class="form-control" placeholder="Ex: 50000,00" />
                            </div>
                            <span asp-validation-for="ValorMercado" class="text-danger small"></span>
                            <small class="text-muted">Valor estimado do veículo no mercado</small>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="StatusCarroId" class="form-label required"></label>
                            <select asp-for="StatusCarroId" class="form-select" asp-items="ViewBag.StatusCarroId"></select>
                            <span asp-validation-for="StatusCarroId" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="AgenciaId" class="form-label required"></label>
                            <select asp-for="AgenciaId" class="form-select" asp-items="ViewBag.AgenciaId"></select>
                            <span asp-validation-for="AgenciaId" class="text-danger small"></span>
                        </div>
                    </div>

                    @if (locacoesAtivas > 0)
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Atenção:</strong> Este veículo possui @locacoesAtivas locação(ões) ativa(s).
                            Algumas alterações podem afetar contratos em andamento.
                        </div>
                    }

                    <!-- Botões -->
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-success" id="btnSalvar">
                            <i class="fas fa-save me-2"></i>Salvar Alterações
                        </button>
                        <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Voltar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar com Informações -->
    <div class="col-lg-4">
        <!-- Card de Estatísticas -->
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar me-1"></i>Estatísticas do Veículo
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-primary mb-0">@(Model.Locacoes?.Count ?? 0)</h4>
                            <small class="text-muted">Locações</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success mb-0">@(Model.Locacoes?.Sum(l => l.ValorTotal).ToString("C") ?? "R$ 0,00")</h4>
                        <small class="text-muted">Receita</small>
                    </div>
                </div>
                
                @if (Model.Locacoes?.Any() == true)
                {
                    <hr>
                    <div class="text-center">
                        <small class="text-muted">Receita Média por Locação:</small><br>
                        <strong class="text-success h6">@((Model.Locacoes.Sum(l => l.ValorTotal) / Model.Locacoes.Count).ToString("C"))</strong>
                    </div>
                }

                <hr>
                <div class="small">
                    <p class="mb-1">
                        <i class="fas fa-calendar-plus text-info me-1"></i>
                        <strong>Cadastrado em:</strong> @(Model.DataCadastro.ToString("dd/MM/yyyy") ?? "N/A")
                    </p>
                    <p class="mb-1">
                        <i class="fas fa-traffic-light me-1"></i>
                        <strong>Status atual:</strong> 
                        <span class="badge @(statusAtual switch {
                            "Disponível" => "bg-success",
                            "Alugado" => "bg-warning",
                            "Manutenção" => "bg-danger",
                            _ => "bg-secondary"
                        })">@statusAtual</span>
                    </p>
                    <p class="mb-0">
                        <i class="fas fa-clock text-warning me-1"></i>
                        <strong>Última edição:</strong> Agora
                    </p>
                </div>
            </div>
        </div>

        <!-- Card de Status e Restrições -->
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-1"></i>Status e Restrições
                </h6>
            </div>
            <div class="card-body">
                @if (locacoesAtivas > 0)
                {
                    <div class="alert alert-danger small">
                        <i class="fas fa-handshake me-1"></i>
                        <strong>@locacoesAtivas locação(ões) ativa(s)</strong><br>
                        Algumas alterações podem ser restritas
                    </div>
                }
                
                @if (temLocacoes)
                {
                    <div class="alert alert-info small">
                        <i class="fas fa-history me-1"></i>
                        <strong>Histórico preservado</strong><br>
                        Veículo com @(Model.Locacoes?.Count ?? 0) locação(ões) no histórico
                    </div>
                }

                <div class="alert alert-warning small">
                    <i class="fas fa-info-circle me-1"></i>
                    Alterações nos dados podem afetar:
                    <ul class="mb-0 mt-1">
                        <li>Locações ativas</li>
                        <li>Relatórios financeiros</li>
                        <li>Histórico de manutenção</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Card de Ações Rápidas -->
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-tools me-1"></i>Ações Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    @if (statusAtual == "Disponível")
                    {
                        <a asp-controller="Locacoes" asp-action="Create" asp-route-veiculoId="@Model.Id" 
                           class="btn btn-success btn-sm">
                            <i class="fas fa-plus me-1"></i>Nova Locação
                        </a>
                    }
                    
                    @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
                    {
                        @if (statusAtual != "Manutenção")
                        {
                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                    onclick="alterarStatusRapido(@Model.Id, 'Manutenção')">
                                <i class="fas fa-wrench me-1"></i>Marcar para Manutenção
                            </button>
                        }

                        @if (statusAtual == "Manutenção")
                        {
                            <button type="button" class="btn btn-outline-success btn-sm" 
                                    onclick="alterarStatusRapido(@Model.Id, 'Disponível')">
                                <i class="fas fa-check me-1"></i>Marcar como Disponível
                            </button>
                        }

                        <button type="button" class="btn btn-outline-info btn-sm" 
                                onclick="verificarDisponibilidade(@Model.Id)">
                            <i class="fas fa-calendar-check me-1"></i>Verificar Disponibilidade
                        </button>
                    }

                    <a asp-action="Details" asp-route-id="@Model.Id" 
                       class="btn btn-outline-info btn-sm">
                        <i class="fas fa-eye me-1"></i>Ver Histórico Completo
                    </a>

                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                            onclick="gerarRelatorioVeiculo(@Model.Id)">
                        <i class="fas fa-file-pdf me-1"></i>Gerar Relatório
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Formatação automática de placa
            $('#placaInput').on('input', function() {
                let val = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                
                // Formato antigo: ABC-1234
                if (val.length > 3 && val.length <= 7 && /^[A-Z]{3}[0-9]/.test(val)) {
                    val = val.substring(0, 3) + '-' + val.substring(3);
        }
                
                this.value = val;
            });

            // Validação simples
            $('form').on('submit', function(e) {
                let isValid = true;
                
                // Validar campos obrigatórios
                $(this).find('input[required], select[required]').each(function() {
                    if (!$(this).val()) {
                        $(this).addClass('is-invalid');
                        isValid = false;
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    alert('Por favor, preencha todos os campos obrigatórios');
                    return false;
                }
            });
        });
    </script>
}

<style>
    .required::after {
        content: " *";
        color: red;
    }
    
    .is-invalid {
        border-color: #dc3545 !important;
    }
</style>
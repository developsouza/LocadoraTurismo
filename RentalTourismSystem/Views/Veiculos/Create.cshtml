@model RentalTourismSystem.Models.Veiculo
@{
    ViewData["Title"] = "Novo Veículo";
}

<div class="row">
    <div class="col-12">
        <h2 class="text-gradient">
            <i class="fas fa-car me-2"></i>Cadastrar Novo Veículo
        </h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-action="Index" class="text-decoration-none">Veículos</a></li>
                <li class="breadcrumb-item active">Novo Veículo</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card hover-lift">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-car me-2"></i>Dados do Veículo</h5>
            </div>
            <div class="card-body">
                <!-- ✅ CORRIGIDO: Formulário agora tem ID e método correto -->
                <form asp-action="Create" method="post" id="formNovoVeiculo">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <!-- Identificação -->
                    <h6 class="text-primary border-bottom pb-2 mb-3">
                        <i class="fas fa-info-circle me-2"></i>Identificação
                    </h6>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="Marca" class="form-label required"></label>
                            <input asp-for="Marca" class="form-control" list="marcas" placeholder="Ex: Toyota" />
                            <datalist id="marcas">
                                <option value="Toyota" />
                                <option value="Volkswagen" />
                                <option value="Chevrolet" />
                                <option value="Ford" />
                                <option value="Fiat" />
                                <option value="Honda" />
                                <option value="Hyundai" />
                                <option value="Nissan" />
                                <option value="Renault" />
                            </datalist>
                            <span asp-validation-for="Marca" class="text-danger small"></span>
                        </div>

                        <div class="col-md-5 mb-3">
                            <label asp-for="Modelo" class="form-label required"></label>
                            <input asp-for="Modelo" class="form-control" placeholder="Ex: Corolla" />
                            <span asp-validation-for="Modelo" class="text-danger small"></span>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label asp-for="Ano" class="form-label required"></label>
                            <input asp-for="Ano" class="form-control" type="number" min="1990" max="2030" />
                            <span asp-validation-for="Ano" class="text-danger small"></span>
                            <div id="ano-info"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="Placa" class="form-label required"></label>
                            <input asp-for="Placa" class="form-control" id="placaInput" placeholder="ABC-1234 ou ABC1D23" maxlength="8" />
                            <span asp-validation-for="Placa" class="text-danger small"></span>
                            <div id="placa-validation-feedback"></div>
                            <small class="text-muted">Formato antigo ou Mercosul</small>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="Cor" class="form-label required"></label>
                            <input asp-for="Cor" class="form-control" placeholder="Ex: Branco" />
                            <span asp-validation-for="Cor" class="text-danger small"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="Quilometragem" class="form-label required"></label>
                            <input asp-for="Quilometragem" class="form-control" type="number" min="0" />
                            <span asp-validation-for="Quilometragem" class="text-danger small"></span>
                            <div id="km-validation-feedback"></div>
                        </div>
                    </div>

                    <!-- Características -->
                    <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                        <i class="fas fa-cogs me-2"></i>Características
                    </h6>

                    <div class="row">
                        <!-- ✅ CORRIGIDO: Campos agora com validação -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="Combustivel" class="form-label required"></label>
                            <select asp-for="Combustivel" class="form-select">
                                <option value="">Selecione...</option>
                                <option value="Gasolina">Gasolina</option>
                                <option value="Álcool">Álcool</option>
                                <option value="Flex">Flex (Gasolina/Álcool)</option>
                                <option value="Diesel">Diesel</option>
                                <option value="GNV">GNV</option>
                                <option value="Híbrido">Híbrido</option>
                                <option value="Elétrico">Elétrico</option>
                            </select>
                            <span asp-validation-for="Combustivel" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label asp-for="Cambio" class="form-label required"></label>
                            <select asp-for="Cambio" class="form-select">
                                <option value="">Selecione...</option>
                                <option value="Manual">Manual</option>
                                <option value="Automático">Automático</option>
                                <option value="Automatizado">Automatizado</option>
                                <option value="CVT">CVT</option>
                            </select>
                            <span asp-validation-for="Cambio" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Valores e Status -->
                    <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                        <i class="fas fa-dollar-sign me-2"></i>Valor e Status
                    </h6>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="ValorDiaria" class="form-label required"></label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input asp-for="ValorDiaria" class="form-control" />
                            </div>
                            <span asp-validation-for="ValorDiaria" class="text-danger small"></span>
                            <div id="valor-validation-feedback"></div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="ValorMercado" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input asp-for="ValorMercado" class="form-control" placeholder="Ex: 50000,00" />
                            </div>
                            <span asp-validation-for="ValorMercado" class="text-danger small"></span>
                            <small class="text-muted">Valor estimado do veículo no mercado</small>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label asp-for="StatusCarroId" class="form-label required"></label>
                            <select asp-for="StatusCarroId" class="form-select" asp-items="ViewBag.StatusCarroId"></select>
                            <span asp-validation-for="StatusCarroId" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="AgenciaId" class="form-label required"></label>
                            <select asp-for="AgenciaId" class="form-select" asp-items="ViewBag.AgenciaId"></select>
                            <span asp-validation-for="AgenciaId" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- ✅ CORRIGIDO: Botões com ID -->
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-success" id="btnSalvar">
                            <i class="fas fa-save me-2"></i>Salvar
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="limparFormulario()">
                            <i class="fas fa-eraser me-2"></i>Limpar
                        </button>
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Voltar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar com Informações -->
    <div class="col-lg-4">
        <!-- Card de Validações -->
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-check-circle me-1"></i>Validações em Tempo Real
                </h6>
            </div>
            <div class="card-body">
                <div class="validation-status">
                    <div class="validation-item mb-2" id="status-placa">
                        <i class="fas fa-circle text-muted me-2"></i>
                        <span>Validação de placa</span>
                    </div>
                    <div class="validation-item mb-2" id="status-valor">
                        <i class="fas fa-circle text-muted me-2"></i>
                        <span>Valor da diária</span>
                    </div>
                    <div class="validation-item mb-2" id="status-km">
                        <i class="fas fa-circle text-muted me-2"></i>
                        <span>Quilometragem coerente</span>
                    </div>
                    <div class="validation-item mb-2" id="status-ano">
                        <i class="fas fa-circle text-muted me-2"></i>
                        <span>Ano válido</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card de Calculadora de Valor -->
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-calculator me-1"></i>Calculadora de Valor
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <label class="form-label small">Categoria do Veículo:</label>
                    <select class="form-select form-select-sm" id="categoriaVeiculo" onchange="sugerirValor()">
                        <option value="">Selecione...</option>
                        <option value="economico">Econômico</option>
                        <option value="compacto">Compacto</option>
                        <option value="intermediario">Intermediário</option>
                        <option value="executivo">Executivo</option>
                        <option value="suv">SUV</option>
                        <option value="luxo">Luxo</option>
                        <option value="pickup">Pick-up</option>
                    </select>
                </div>
                <div class="text-center">
                    <small class="text-muted">Valor sugerido:</small><br>
                    <span id="valorSugerido" class="fw-bold text-success">R$ 0,00</span>
                </div>
                <button type="button" class="btn btn-outline-warning btn-sm w-100 mt-2" onclick="aplicarValorSugerido()">
                    <i class="fas fa-arrow-down me-1"></i>Aplicar Valor
                </button>
            </div>
        </div>

        <!-- Card de Preview -->
        <div class="card mb-4" id="previewVeiculo" style="display: none;">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-eye me-1"></i>Preview do Veículo
                </h6>
            </div>
            <div class="card-body">
                <div id="veiculoPreview"></div>
            </div>
        </div>

        <!-- Card de Dicas -->
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-1"></i>Dicas Importantes
                </h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <p>
                        <i class="fas fa-info-circle text-info me-1"></i>
                        <strong>Formatação automática:</strong> Placa é formatada automaticamente.
                    </p>
                    <p>
                        <i class="fas fa-shield-alt text-success me-1"></i>
                        <strong>Validação instantânea:</strong> Placa é validada em tempo real.
                    </p>
                    <p>
                        <i class="fas fa-car text-warning me-1"></i>
                        <strong>Status inicial:</strong> Novos veículos geralmente ficam "Disponível".
                    </p>
                    <p>
                        <i class="fas fa-calculator text-primary me-1"></i>
                        <strong>Valor sugerido:</strong> Use a calculadora para sugestão de preços.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function() {
            const anoAtual = new Date().getFullYear();

            // Formatação automática de placa
            $('#placaInput').on('input', function() {
                let val = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');

                // Formato antigo: ABC-1234
                if (val.length > 3 && val.length <= 7 && /^[A-Z]{3}[0-9]/.test(val)) {
                    val = val.substring(0, 3) + '-' + val.substring(3);
                }

                this.value = val;
                validarPlaca();
            });

            // Definir ano atual como padrão
            if (!$('#Ano').val()) {
                $('#Ano').val(anoAtual);
            }

            // Validações em tempo real para atualizar o card
            $('#placaInput').on('input blur', validarPlaca);
            $('#ValorDiaria').on('input change', validarValor);
            $('#Quilometragem, #Ano').on('input change', validarQuilometragem);
            $('#Ano').on('change', validarAno);

            // Inicializar validações
            validarPlaca();
            validarValor();
            validarQuilometragem();
            validarAno();
        });

        // ===== FUNÇÕES DE VALIDAÇÃO EM TEMPO REAL =====
        
        function validarPlaca() {
            const placa = $('#placaInput').val().replace(/[^A-Z0-9]/g, '');
            const $statusPlaca = $('#status-placa');
            
            if (!placa) {
                $statusPlaca.html('<i class="fas fa-circle text-muted me-2"></i><span>Validação de placa</span>');
                $('#placa-validation-feedback').html('');
                return;
            }
            
            // Regex para formato antigo (ABC1234) ou Mercosul (ABC1D23)
            const formatoAntigo = /^[A-Z]{3}[0-9]{4}$/;
            const formatoMercosul = /^[A-Z]{3}[0-9][A-Z][0-9]{2}$/;
            
            if (formatoAntigo.test(placa) || formatoMercosul.test(placa)) {
                $statusPlaca.html('<i class="fas fa-check-circle text-success me-2"></i><span>Placa válida</span>');
                $('#placa-validation-feedback').html('<small class="text-success"><i class="fas fa-check"></i> Formato válido</small>');
            } else if (placa.length < 7) {
                $statusPlaca.html('<i class="fas fa-circle text-warning me-2"></i><span>Placa incompleta</span>');
                $('#placa-validation-feedback').html('<small class="text-muted"><i class="fas fa-info-circle"></i> Continue digitando...</small>');
            } else {
                $statusPlaca.html('<i class="fas fa-times-circle text-danger me-2"></i><span>Placa inválida</span>');
                $('#placa-validation-feedback').html('<small class="text-danger"><i class="fas fa-times"></i> Formato inválido</small>');
            }
        }

        function validarValor() {
            const valor = parseFloat($('#ValorDiaria').val()) || 0;
            const $statusValor = $('#status-valor');
            
            if (valor === 0) {
                $statusValor.html('<i class="fas fa-circle text-muted me-2"></i><span>Valor da diária</span>');
                $('#valor-validation-feedback').html('');
                return;
            }
            
            if (valor > 0 && valor < 50) {
                $statusValor.html('<i class="fas fa-exclamation-triangle text-warning me-2"></i><span>Valor baixo</span>');
                $('#valor-validation-feedback').html('<small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Valor baixo para mercado</small>');
            } else if (valor >= 50 && valor <= 500) {
                $statusValor.html('<i class="fas fa-check-circle text-success me-2"></i><span>Valor adequado</span>');
                $('#valor-validation-feedback').html('<small class="text-success"><i class="fas fa-check-circle"></i> Valor adequado</small>');
            } else if (valor > 500) {
                $statusValor.html('<i class="fas fa-star text-info me-2"></i><span>Valor premium</span>');
                $('#valor-validation-feedback').html('<small class="text-info"><i class="fas fa-info-circle"></i> Valor premium</small>');
            }
        }

        function validarQuilometragem() {
            const ano = parseInt($('#Ano').val()) || 0;
            const km = parseInt($('#Quilometragem').val()) || 0;
            const $statusKm = $('#status-km');
            const anoAtual = new Date().getFullYear();
            
            if (!ano || !km) {
                $statusKm.html('<i class="fas fa-circle text-muted me-2"></i><span>Quilometragem coerente</span>');
                $('#km-validation-feedback').html('');
                return;
            }

            const idade = anoAtual - ano;
            const kmEsperado = idade * 15000;

            if (idade === 0 && km <= 100) {
                $statusKm.html('<i class="fas fa-check-circle text-success me-2"></i><span>Veículo novo</span>');
                $('#km-validation-feedback').html('<small class="text-success"><i class="fas fa-check"></i> Veículo novo</small>');
            } else if (km > kmEsperado * 2) {
                $statusKm.html('<i class="fas fa-exclamation-triangle text-warning me-2"></i><span>KM alta</span>');
                $('#km-validation-feedback').html('<small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Quilometragem alta para o ano</small>');
            } else if (km > kmEsperado * 0.5 && km <= kmEsperado * 2) {
                $statusKm.html('<i class="fas fa-check-circle text-success me-2"></i><span>KM coerente</span>');
                $('#km-validation-feedback').html('<small class="text-success"><i class="fas fa-check"></i> Quilometragem coerente</small>');
            } else {
                $statusKm.html('<i class="fas fa-info-circle text-info me-2"></i><span>KM baixa</span>');
                $('#km-validation-feedback').html('<small class="text-info"><i class="fas fa-info-circle"></i> Quilometragem baixa para o ano</small>');
            }
        }

        function validarAno() {
            const ano = parseInt($('#Ano').val()) || 0;
            const $statusAno = $('#status-ano');
            const anoAtual = new Date().getFullYear();
            
            if (!ano) {
                $statusAno.html('<i class="fas fa-circle text-muted me-2"></i><span>Ano válido</span>');
                $('#ano-info').html('');
                return;
            }
            
            if (ano < 1990) {
                $statusAno.html('<i class="fas fa-exclamation-triangle text-warning me-2"></i><span>Ano muito antigo</span>');
                $('#ano-info').html('<small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Veículo muito antigo</small>');
            } else if (ano > anoAtual + 1) {
                $statusAno.html('<i class="fas fa-times-circle text-danger me-2"></i><span>Ano inválido</span>');
                $('#ano-info').html('<small class="text-danger"><i class="fas fa-times"></i> Ano futuro inválido</small>');
            } else if (ano === anoAtual || ano === anoAtual + 1) {
                $statusAno.html('<i class="fas fa-star text-success me-2"></i><span>Veículo novo</span>');
                $('#ano-info').html('<small class="text-success"><i class="fas fa-star"></i> Veículo novo/zero km</small>');
            } else {
                $statusAno.html('<i class="fas fa-check-circle text-success me-2"></i><span>Ano válido</span>');
                const idade = anoAtual - ano;
                $('#ano-info').html(`<small class="text-info"><i class="fas fa-info-circle"></i> ${idade} ano(s) de uso</small>`);
            }
        }

        // ===== CALCULADORA DE VALOR =====
        
        function sugerirValor() {
            const categoria = $('#categoriaVeiculo').val();
            const $valorSugerido = $('#valorSugerido');
            
            const valores = {
                'economico': 80,
                'compacto': 120,
                'intermediario': 180,
                'executivo': 280,
                'suv': 350,
                'luxo': 600,
                'pickup': 400
            };
            
            if (!categoria) {
                $valorSugerido.text('R$ 0,00');
                return;
            }
            
            const valor = valores[categoria] || 0;
            $valorSugerido.text('R$ ' + valor.toFixed(2).replace('.', ','));
        }

        function aplicarValorSugerido() {
            const categoria = $('#categoriaVeiculo').val();
            
            if (!categoria) {
                alert('⚠️ Selecione uma categoria primeiro!');
                return;
            }
            
            const valores = {
                'economico': 80,
                'compacto': 120,
                'intermediario': 180,
                'executivo': 280,
                'suv': 350,
                'luxo': 600,
                'pickup': 400
            };
            
            const valor = valores[categoria] || 0;
            $('#ValorDiaria').val(valor.toFixed(2));
            
            // Trigger change para atualizar validação
            $('#ValorDiaria').trigger('change');
            
            // Feedback visual
            const $btn = event.target;
            const originalText = $btn.innerHTML;
            $btn.innerHTML = '<i class="fas fa-check me-1"></i>Aplicado!';
            $btn.disabled = true;
            
            setTimeout(() => {
                $btn.innerHTML = originalText;
                $btn.disabled = false;
            }, 2000);
        }

        function limparFormulario() {
            if (confirm('Tem certeza que deseja limpar o formulário?')) {
                document.getElementById('formNovoVeiculo').reset();
                $('#Ano').val(new Date().getFullYear());
                
                // Resetar validações
                $('#placa-validation-feedback, #valor-validation-feedback, #km-validation-feedback, #ano-info').html('');
                $('#status-placa, #status-valor, #status-km, #status-ano').each(function() {
                    const texto = $(this).find('span').text();
                    $(this).html('<i class="fas fa-circle text-muted me-2"></i><span>' + texto + '</span>');
                });
                
                // Resetar calculadora
                $('#categoriaVeiculo').val('');
                $('#valorSugerido').text('R$ 0,00');
            }
        }
    </script>
}

<style>
    .required::after {
        content: " *";
        color: red;
    }
    
    .validation-item {
        transition: all 0.3s ease;
    }
    
    .validation-item i.fa-check-circle {
        animation: pulse 0.5s ease;
    }
    
    @@keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
</style>
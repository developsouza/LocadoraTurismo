@model RentalTourismSystem.Models.PacoteViagem
@{
    ViewData["Title"] = "Novo Pacote de Viagem";
}

<div class="row">
    <div class="col-12">
        <h2>
            <i class="fas fa-plus me-2"></i>Novo Pacote de Viagem
        </h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-action="Index">Pacotes</a></li>
                <li class="breadcrumb-item active">Novo</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Informações do Pacote</h5>
            </div>
            <div class="card-body">
                <!-- ATUALIZADO: Adicionadas classes de validação -->
                <form asp-action="Create" class="needs-validation form-pacote" novalidate>
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-3">
                        <!-- ATUALIZADO: Label com classe required -->
                        <label asp-for="Nome" class="form-label required">Nome do Pacote</label>
                        <input asp-for="Nome" class="form-control"
                               placeholder="Ex: Passeio de Buggy pelas Dunas"
                               required minlength="5" maxlength="100" />
                        <span asp-validation-for="Nome" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Descricao" class="form-label required">Descrição</label>
                        <textarea asp-for="Descricao" class="form-control" rows="4"
                                  placeholder="Descreva o que está incluído no pacote: transporte, guia, equipamentos, refeições, etc."
                                  required minlength="20" maxlength="1000"></textarea>
                        <span asp-validation-for="Descricao" class="text-danger"></span>
                        <div class="form-text">Descreva detalhadamente o que está incluído no pacote</div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label asp-for="Destino" class="form-label required">Destino</label>
                            <input asp-for="Destino" class="form-control"
                                   placeholder="Ex: Canoa Quebrada - CE"
                                   required minlength="3" maxlength="100" />
                            <span asp-validation-for="Destino" class="text-danger"></span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check form-switch mt-4">
                                <input asp-for="Ativo" class="form-check-input" type="checkbox" checked />
                                <label asp-for="Ativo" class="form-check-label">Pacote Ativo</label>
                            </div>
                            <div class="form-text">Pacotes inativos não aparecem para reserva</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Duracao" class="form-label required">Duração</label>
                            <input asp-for="Duracao" class="form-control" type="number"
                                   min="1" max="365" placeholder="Ex: 4" required />
                            <span asp-validation-for="Duracao" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="UnidadeTempo" class="form-label required">Unidade de Tempo</label>
                            <select asp-for="UnidadeTempo" class="form-select" required>
                                <option value="">Selecione a unidade</option>
                                <option value="horas">Horas</option>
                                <option value="dias" selected>Dias</option>
                            </select>
                            <span asp-validation-for="UnidadeTempo" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Preco" class="form-label required">Preço por Pessoa</label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <!-- ATUALIZADO: Máscara monetária e validação -->
                            <input asp-for="Preco" class="form-control money-mask"
                                   placeholder="150,00" required data-rule-valor-minimo="1" />
                        </div>
                        <span asp-validation-for="Preco" class="text-danger"></span>
                        <div class="form-text">Preço que será cobrado por pessoa na reserva</div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>Salvar Pacote
                        </button>
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Voltar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-1"></i>Dicas de Criação
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-1"></i>
                        Use nomes descritivos e atrativos
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-1"></i>
                        Para passeios rápidos (buggy, jet ski), use <strong>horas</strong>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-1"></i>
                        Para viagens longas (pacotes completos), use <strong>dias</strong>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-1"></i>
                        Inclua detalhes sobre hospedagem e refeições
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-1"></i>
                        Especifique atividades incluídas
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-1"></i>
                        Defina preços competitivos
                    </li>
                </ul>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-examples me-1"></i>Exemplos
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong class="text-primary">Passeio de Buggy</strong>
                    <ul class="small mt-1 mb-0">
                        <li>Duração: <strong>4 horas</strong></li>
                        <li>Inclui: Transporte e guia</li>
                        <li>Preço: R$ 80,00 por pessoa</li>
                    </ul>
                </div>
                <div class="mb-3">
                    <strong class="text-success">Pacote Jericoacoara</strong>
                    <ul class="small mt-1 mb-0">
                        <li>Duração: <strong>3 dias</strong></li>
                        <li>Inclui: Hospedagem e refeições</li>
                        <li>Preço: R$ 450,00 por pessoa</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- NOVO: Preview da duração -->
        <div class="card mt-3" id="previewCard" style="display: none;">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-eye me-1"></i>Preview
                </h6>
            </div>
            <div class="card-body">
                <div id="durationPreview"></div>
                <div id="pricePreview" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Validações automáticas aplicadas pela classe form-pacote
            console.log('Validações de pacote aplicadas');

            // Preview da duração e preço
            $('#Duracao, #UnidadeTempo, #Preco').on('input change', atualizarPreview);

            // Validação de descrição mínima
            $('#Descricao').on('blur', function() {
                const descricao = $(this).val();
                if (descricao && descricao.length < 20) {
                    if (typeof NotificacaoValidacao !== 'undefined') {
                        NotificacaoValidacao.aviso('A descrição deve ter pelo menos 20 caracteres para ser informativa.');
                    }
                }
            });

            // Sugerir preços baseados na duração
            $('#Duracao, #UnidadeTempo').on('change', function() {
                sugerirPreco();
            });
        });

        function atualizarPreview() {
            const duracao = $('#Duracao').val();
            const unidade = $('#UnidadeTempo').val();
            const preco = $('#Preco').val();

            let hasContent = false;
            let previewContent = '';

            if (duracao && unidade) {
                previewContent += `<div><i class="fas fa-clock me-1"></i><strong>${duracao} ${unidade}</strong></div>`;
                hasContent = true;
            }

            if (preco) {
                // CORRIGIDO: Tratamento robusto do valor monetário
                // Remove todos os caracteres exceto números e vírgula
                const precoLimpo = preco.replace(/[^\d,]/g, '').replace(',', '.');
                const precoNumerico = parseFloat(precoLimpo);

                // Verifica se é um número válido
                if (!isNaN(precoNumerico) && precoNumerico > 0) {
                    const precoFormatado = precoNumerico.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    });
                    previewContent += `<div class="mt-1"><i class="fas fa-money-bill me-1"></i><strong>${precoFormatado} por pessoa</strong></div>`;
                    hasContent = true;
                } else {
                    // Se não for um número válido, mostra mensagem de espera
                    previewContent += `<div class="mt-1 text-muted"><i class="fas fa-money-bill me-1"></i><small>Digite um valor válido</small></div>`;
                    hasContent = true;
                }
            }

            if (hasContent) {
                $('#durationPreview').html(previewContent);
                $('#previewCard').show();
            } else {
                $('#previewCard').hide();
            }
        }

        function sugerirPreco() {
            const duracao = parseInt($('#Duracao').val());
            const unidade = $('#UnidadeTempo').val();
            const precoAtual = $('#Preco').val();

            // Só sugerir se não há preço ou preço é zero
            if (!precoAtual || precoAtual == '0' || precoAtual == '0,00') {
                let precoSugerido = 0;

                if (duracao && unidade) {
                    if (unidade === 'horas') {
                        // Passeios por horas: R$ 20-30 por hora
                        precoSugerido = duracao * 25;
                    } else if (unidade === 'dias') {
                        // Pacotes por dias: R$ 150-200 por dia
                        precoSugerido = duracao * 175;
                    }

                    if (precoSugerido > 0) {
                        // CORRIGIDO: Formatar corretamente para o formato brasileiro
                        const precoFormatado = precoSugerido.toLocaleString('pt-BR', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });

                        $('#Preco').val(precoFormatado);

                        // Notificação
                        if (window.RentalTourismSystem?.NotificationSystem) {
                            window.RentalTourismSystem.NotificationSystem.info(`Preço sugerido aplicado: R$ ${precoFormatado}`);
                        } else if (typeof NotificacaoValidacao !== 'undefined') {
                            NotificacaoValidacao.info(`Preço sugerido aplicado: R$ ${precoFormatado}`);
                        }

                        // Atualizar preview
                        atualizarPreview();
                    }
                }
            }
        }
    </script>
}